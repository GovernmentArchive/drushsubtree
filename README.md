Drush Subtree
=============

Overview
--------

Drush Subtree's goal is to improve Drupal developers' ability to
make their work reusable. It provides a wrapper around git-subtree to simplify
management of Git repos inside a parent repo and it provides integration with
Drush's Build Manager extension. This enables you to:

  - Use Build Manager's interactive prompt to set your site up with Git subtrees
    for projects you maintain outsite the parent site repository.

  - Do development inside whatever site repo you're actively working in,
    then push commits out of your site repo up to drupal.org or (whatever
    private repo your custom module or theme lives in).

  - Pull updates into your site repo from an outside repo for your
    distro, module, theme, or custom project.

  - For teams working together on a site repository, this enables team
    members to contribute to a project inside a site repo, through your own
    internal workflow. Then it enables you--the maintainer--to easily push that
    work out to public repos when it's ready to be released.

  - Incorporate Git subtrees into Drush Make builds for your site repository.
    (Provides support for checking out tagged versions of projects, no commit
    ID required.)


Dependencies
------------

  - [git-subtree](https://github.com/git/git/tree/master/contrib/subtree)
  - [Build Manager](https://github.com/whitehouse/buildmanager) - Note: even if you
    don't use Build Manager to manager Drush Make builds, Drush Subtree expects
    you to store info about your subtrees in a Build Manager configuration file.
  - (Recommended) Drush master / 7.x (Build Manager uses the Drush Make
    --no-recurse flag and autoloading which--as of the time of this writing--
    ave not been backported to 6.x)

Usage
-----

Store info about your site repository's subtrees in a Build Manager
configuration file. Use the interactive prompt to have Build Manager generate
this file for you, or see examples
[here](https://github.com/whitehouse/buildmanager) to create the file manually.

Start the interactive prompt like this:

    drush buildmanager-configure

Next you can manually add/update subtrees with the commands described below, or via automated
Build Manger builds. (See [Build Manger integration](#build-manager-integration)
for information on how Drush Subtree works with automateds builds managed
by Drush Make and Build Manager.)

If you're already familiar with git-subtree, see documentation and examples for
the `subtree` command. This interface is the same as git subtree's with a few
simplifications (it grabs parameters from your Build Manager config, so you
don't have to type in those parameters over and over or worry about possible
human error). For more details and examples, see:

    drush subtree --help

If you're not familiar with git-subtree, you may prefer the more Drush-y
interface, *drush subtree-\<verb\> \<args\>*, see:

    drush --filter=drushsubtree

Here's a quick overview of the main commands:

    # Note: All the commands below are pushing to or pulling from a remote
    # repository specified in your Build Manager config file.

    # Add a subtree to the parent repository.
    drush subtree add <project>                

    # Pull updates in from outside your site repo.
    drush subtree pull <project>               

    # Push updates out to external repo from inside your site repo.
    drush subtree push <project>               

    # "Checkout" a tagged version of a subtree project (e.g. 7.x-2.1) inside your
    # site repository. Note: This is a faux subtree command. (It only exists via
    # Drush Subtree, there is no `git subtree checkout` command.)
    drush subtree checkout <project> <tag>

    # Specify a particular commit ID to use or "checkout" for a subtree project.
    drush subtree merge <project> <id>

Tips for getting started:

  - To see what's going on with git under the hood, use Drush's verbose flag `-v`
  - To examine shell commands generated by Drush Subtree without running them,
    use Drush's `--simulate` flag.
  - Don't include changes to multiple projects (i.e. two different modules) all
    in the same commit. For a project stored in a subtree, this enables you to push
    changes out cleanly. For projects that are NOT stored in a subtree, this
    will make it easy for you to break custom projects out of your site repo and
    make them stand-alone projects later, without losing your commit history.
 

Build Manager integration
-------------------------

Drush Subtree integrates with Build Manager to provide a few niceties:

  - Hooks into the `drush buildmanager-configure` interactive prompt to help you
    set up and manage subtrees
  - Hooks into `drush buildmanager-build` to figure out which projects
    referenced in your make file(s) are subtrees and manage them accordingly
    during your automated (re)builds

There are a few things you should know about how this works:

**Re. Drush Make**: Follow the tips for setting up your build.make file included
in the Build Manager documentation
[here](https://github.com/whitehouse/buildmanager#tips-for-working-with-make-files).
Drush Subtree assumes you are using the `--no-recurse` flag with your builds. If
you do NOT use `--no-recurse` Drush Subtree will not be able to detect subtrees
and versions included make files that are added during runtime, this would lead
to inconsistent and confusing results.

**Re. Distros**: You can't store subtrees inside subtrees. If you maintain a
distro AND maintain any contrib projects included in that distro, don't organize
your directories like this:

    my-repo/docroot/profiles/my-profile/modules/contrib/my-module
    <parent-repo>/docroot/profiles/<subtree>/modules/contrib/<subtree>
 
Instead, do this:

    # Only store your profile project (and any included custom modules that live
    # in that same repo) here:
    my-repo/docroot/profiles/my-profile

    # Contrib projects go in sites/all like my-module here:
    my-repo/docroot/sites/all/modules/contrib/my-module

    # If you want to make clear in the build, which contrib projects are being
    # included by the distro, name the directory containing all the contrib
    # projects after your profile, rather than "contrib", like this:
    my-repo/docroot/sites/all/modules/my-profile/my-module

To get drush make to build your code base ^^ this way, you can either (a) move
the contents of drupal-org.make into your build-myprofile.make file, or (b)
create your own build.make with includes referencing build-myprofile.make and
drupal-org.make and pass drush make the --no-recurse flag.
